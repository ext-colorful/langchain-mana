# 智能食物识别与营养分析系统 - 需求文档与接口定义

## 1. 项目概述

### 1.1 项目简介
本项目是一个基于 LangChain 框架的智能食物识别与营养分析系统。系统通过 AI 技术（支持 ChatGPT 和智谱 AI）实现：
- 从文本描述中提取食物信息
- 从图片中识别食物
- 分析食物的营养成分
- 使用 RAG（检索增强生成）技术进行食材知识库检索
- 管理用户的餐食记录和食材数据

### 1.2 技术栈
- **AI框架**: LangChain
- **LLM支持**: OpenAI (ChatGPT), 智谱AI (GLM-4V)
- **数据库**: PostgreSQL 
- **向量数据库**: ChromaDB
- **文本向量化**: text2vec

### 1.3 系统架构
```
┌─────────────────┐
│   FastAPI API   │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼──────┐
│ 服务层 │ │ 业务链  │
└───┬───┘ └──┬──────┘
    │        │
┌───▼────────▼───┐
│   AI服务层      │
│ (ChatGPT/Zhipu)│
└───┬────────────┘
    │
┌───▼──────────────┐
│   数据存储层      │
│ PostgreSQL +     │
│ ChromaDB (向量)  │
└──────────────────┘
```

## 2. 核心功能需求

### 2.1 文本食物识别
**功能描述**: 从用户提供的文本描述中提取食物信息，包括菜品名称、描述和食材列表。

**业务流程**:
1. 用户输入文本描述（如："今天中午吃了一碗牛肉面"）
2. 系统使用 LLM 提取食物信息
3. 返回结构化的食物信息（菜品名称、描述、食材列表）

**技术要求**:
- 支持中文文本处理
- 使用 Pydantic 模型进行结构化输出
- 自动解析 JSON 响应（支持去除注释）

### 2.2 图片食物识别
**功能描述**: 从用户上传的图片中识别食物信息。

**业务流程**:
1. 用户提供图片 URL
2. 系统使用智谱 AI 的 GLM-4V 模型进行图片识别
3. 返回结构化的食物信息

**技术要求**:
- 使用多模态 AI 模型（GLM-4V-Plus）
- 支持图片 URL 输入
- 输出格式与文本识别一致

### 2.3 营养成分分析
**功能描述**: 基于识别的食物信息，分析详细的营养成分。

**业务流程**:
1. 接收菜品名称和初始食材列表
2. 使用 RAG 技术从向量数据库中检索相关食材信息
3. 使用 LLM 分析并计算营养成分
4. 返回包含卡路里、蛋白质、脂肪、碳水化合物的详细营养信息

**技术要求**:
- 使用 ChromaDB 向量数据库存储食材信息
- 使用 text2vec 模型进行文本向量化
- 支持上下文压缩检索（ContextualCompressionRetriever）
- 考虑烹饪方法对营养成分的影响

### 2.4 食材管理
**功能描述**: 管理食材数据库，支持食材的创建、检索和同步。

**业务流程**:
1. 系统自动从 PostgreSQL 数据库同步食材到向量数据库
2. 支持按名称搜索食材（向量相似度搜索）
3. 如果食材不存在，自动创建新食材记录

**技术要求**:
- 向量数据库与关系数据库双写
- 支持批量同步（每批 1000 条）
- 实时同步进度查询

### 2.5 餐食管理
**功能描述**: 管理用户的餐食记录，包括餐食信息、食材关联和营养分析结果。

**业务流程**:
1. 用户提交餐食信息（文本或图片）
2. 系统识别食物并分析营养成分
3. 创建餐食记录并关联食材
4. 更新餐食状态（AI 识别中、待确认、已确认）

**技术要求**:
- 支持多对多关系（餐食-食材）
- 异步处理餐食识别任务
- 支持状态跟踪

### 2.6 异步任务处理
**功能描述**: 后台异步处理餐食识别任务。

**业务流程**:
1. 系统每分钟扫描一次待处理的餐食识别任务
2. 根据任务类型（文本/图片）调用相应的处理服务
3. 更新任务状态（未开始、进行中、已完成、失败）

**技术要求**:
- 使用 asyncio 实现异步任务
- 支持任务状态跟踪
- 错误处理和重试机制

## 3. 数据模型

### 3.1 Meal (餐食)
```python
{
    "meal_id": int,              # 餐食ID（主键）
    "user_id": str,              # 用户ID（UUID）
    "description": str,          # 菜品描述
    "pic_url": List[str],        # 图片URL列表
    "date_time": datetime,       # 用餐时间
    "ai_status": int,            # AI处理状态
    "detail": str,               # 详细信息
    "ingredients": List[FoodIngredient]  # 关联的食材列表
}
```

**AI状态枚举**:
- `0`: 普通记录
- `1`: AI识别中
- `2`: AI识别完成-待确认
- `3`: 已确认

### 3.2 FoodIngredient (食材)
```python
{
    "id": int,                   # 食材ID（主键）
    "name": str,                 # 食材名称
    "calories": float,           # 卡路里（千卡）
    "protein": float,            # 蛋白质（克）
    "fat": float,                # 脂肪（克）
    "carbohydrates": float,      # 碳水化合物（克）
    "quantity": float,           # 数量
    "unit": str                  # 单位（如：克、份、碗）
}
```

### 3.3 AiMealRecognition (AI餐食识别任务)
```python
{
    "id": int,                   # 任务ID（主键）
    "meal_id": int,              # 关联的餐食ID
    "text": str,                 # 文本描述（可选）
    "pic_url": str,              # 图片URL（可选）
    "ai_chat_message_id": str,   # AI聊天消息ID
    "status": int,               # 任务状态
    "create_time": datetime,     # 创建时间
    "update_time": datetime,     # 更新时间
    "user_id": str               # 用户ID（UUID）
}
```

**任务状态枚举**:
- `0`: 未开始
- `1`: 进行中
- `2`: 已完成
- `3`: 失败
- `4`: 已推送

## 4. API 接口定义

### 4.1 文本处理接口

#### 4.1.1 文本处理（同步）
**接口路径**: `POST /chat/process/`

**请求体**:
```json
{
    "text": "今天中午吃了一碗牛肉面，还有两个鸡蛋"
}
```

**响应体**:
```json
{
    "content": "处理后的文本内容",
    "model": "gpt-4",
    "usage": {
        "prompt_tokens": 100,
        "completion_tokens": 50,
        "total_tokens": 150
    }
}
```

**状态码**:
- `200`: 成功
- `500`: 服务器错误

---

#### 4.1.2 文本处理（流式）
**接口路径**: `POST /chat/process_stream/`

**请求体**:
```json
{
    "text": "今天中午吃了一碗牛肉面"
}
```

**响应格式**: Server-Sent Events (SSE)
```
data: 部分响应内容

data: 部分响应内容

data: [FULL_RESPONSE] 完整响应内容

data: [USAGE] {"prompt_tokens": 100, "completion_tokens": 50, "total_tokens": 150}

data: [DONE]
```

**Content-Type**: `text/event-stream`

**状态码**:
- `200`: 成功
- `500`: 服务器错误

---

### 4.2 食物识别接口

#### 4.2.1 AI食物识别
**接口路径**: `POST /food/ai`

**请求体**:
```json
{
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "timestamp": 1696234567,
    "description": "今天中午吃了一碗牛肉面，还有两个鸡蛋",  // 可选，与image_url二选一
    "image_url": "https://example.com/food.jpg"              // 可选，与description二选一
}
```

**响应体**:
```json
{
    "status": "success",
    "meal": {
        "id": 12345,
        "user_id": "550e8400-e29b-41d4-a716-446655440000",
        "description": "牛肉面配鸡蛋",
        "date_time": "2024-10-01T12:00:00"
    },
    "ingredients": [
        {
            "name": "牛肉",
            "quantity": 100.0,
            "unit": "克"
        },
        {
            "name": "面条",
            "quantity": 200.0,
            "unit": "克"
        },
        {
            "name": "鸡蛋",
            "quantity": 2.0,
            "unit": "个"
        }
    ]
}
```

**状态码**:
- `200`: 成功
- `400`: 请求参数错误（必须提供description或image_url）
- `500`: 服务器错误

**业务逻辑**:
1. 如果提供 `description`，使用文本识别链提取食物信息
2. 如果提供 `image_url`，使用图片识别模型识别食物
3. 使用营养成分分析链分析营养信息
4. 创建餐食记录并关联食材
5. 返回处理结果

---

### 4.3 食材同步接口

#### 4.3.1 启动食材同步
**接口路径**: `POST /sync/start-sync`

**请求体**: 无

**响应体**:
```json
{
    "message": "同步任务已启动"
}
```

或（如果同步任务已在进行中）:
```json
{
    "message": "同步任务已在进行中"
}
```

**状态码**:
- `200`: 成功

**业务逻辑**:
- 在后台异步启动食材同步任务
- 从 PostgreSQL 数据库读取所有食材记录
- 批量（每批 1000 条）同步到 ChromaDB 向量数据库
- 如果已有同步任务在进行，返回提示信息

---

#### 4.3.2 获取食材同步进度
**接口路径**: `GET /sync/sync-progress`

**请求参数**: 无

**响应体**:
```json
{
    "total_ingredients": 10000,
    "synced_ingredients": 7500,
    "remaining": 2500,
    "progress_percentage": 75.0,
    "is_syncing": true
}
```

**状态码**:
- `200`: 成功
- `500`: 服务器错误

**字段说明**:
- `total_ingredients`: 总食材数量
- `synced_ingredients`: 已同步数量
- `remaining`: 剩余数量
- `progress_percentage`: 同步进度百分比
- `is_syncing`: 是否正在同步

---

### 4.4 餐食同步接口

#### 4.4.1 启动餐食同步
**接口路径**: `POST /meal/start-sync`

**请求体**: 无

**响应体**:
```json
{
    "message": "同步任务已启动"
}
```

或（如果同步任务已在进行中）:
```json
{
    "message": "同步任务已在进行中"
}
```

**状态码**:
- `200`: 成功

**业务逻辑**:
- 在后台异步启动餐食同步任务
- 从 PostgreSQL 数据库读取符合条件的餐食记录
- 同步条件：
  - `description != ''`
  - `ai_status IN (0, 3)`
  - 关联的 `events_group.score_status = 2`
  - 关联的 `events_group.simulation_status = 0`
- 批量（每批 1000 条）同步到向量数据库
- 如果已有同步任务在进行，返回提示信息

---

#### 4.4.2 获取餐食同步进度
**接口路径**: `GET /meal/sync-progress`

**请求参数**: 无

**响应体**:
```json
{
    "total_meals": 5000,
    "synced_meals": 3000,
    "remaining": 2000,
    "progress_percentage": 60.0,
    "is_syncing": true
}
```

**状态码**:
- `200`: 成功
- `500`: 服务器错误

**字段说明**:
- `total_meals`: 总餐食数量
- `synced_meals`: 已同步数量
- `remaining`: 剩余数量
- `progress_percentage`: 同步进度百分比
- `is_syncing`: 是否正在同步

---

## 5. 业务链（Chains）说明

### 5.1 食物提取链 (food_extraction)
**功能**: 从文本描述中提取食物信息

**输入**: 文本描述字符串

**输出**: `FoodInfo` 对象
```python
{
    "food_name": str,           # 菜品名称
    "description": str,          # 详细描述
    "ingredients": List[Ingredient]  # 食材列表
}
```

**处理流程**:
1. 构建提示词模板
2. 调用 LLM（ChatGPT 或智谱 AI）
3. 解析 JSON 响应（支持去除注释）
4. 返回结构化数据

---

### 5.2 图片识别链 (image_recognition)
**功能**: 从图片中识别食物信息

**输入**: 图片 URL

**输出**: `FoodInfo` 对象（与文本提取格式一致）

**处理流程**:
1. 使用智谱 AI 的 GLM-4V-Plus 模型
2. 构建多模态提示（图片 + 文本）
3. 解析 JSON 响应
4. 返回结构化数据

---

### 5.3 营养成分分析链 (nutritional_analysis)
**功能**: 分析食物的营养成分

**输入**:
- `food_name`: 菜品名称
- `initial_ingredients`: 初始食材名称列表

**输出**: `NutritionalInfo` 对象
```python
{
    "ingredients": List[Ingredient]  # 包含营养信息的食材列表
}
```

每个 `Ingredient` 包含:
- `name`: 食材名称
- `quantity`: 数量
- `unit`: 单位
- `calories`: 卡路里（千卡）
- `protein`: 蛋白质（克）
- `fat`: 脂肪（克）
- `carbohydrates`: 碳水化合物（克）

**处理流程**:
1. 使用 RAG 技术从向量数据库检索相关食材信息
2. 使用上下文压缩检索器（ContextualCompressionRetriever）优化检索结果
3. 调用 LLM 分析营养成分
4. 考虑烹饪方法对营养成分的影响
5. 返回详细的营养信息

---

## 6. 向量数据库（RAG）说明

### 6.1 食材向量存储
**存储内容**: 食材的向量化表示和元数据

**向量化模型**: text2vec-base-chinese

**存储结构**:
- `documents`: 食材名称（用于检索）
- `metadatas`: 食材的营养信息（卡路里、蛋白质、脂肪、碳水化合物、数量、单位）
- `embeddings`: 食材名称的向量表示
- `ids`: 食材ID

### 6.2 检索机制
**检索方式**: 向量相似度搜索

**检索流程**:
1. 将查询文本向量化
2. 在 ChromaDB 中搜索最相似的食材（Top-K）
3. 返回相似度分数和食材信息

**检索优化**:
- 使用上下文压缩检索器（LLMChainExtractor）
- 根据查询内容动态提取相关信息
- 提高检索精度

---

## 7. 配置说明

### 7.1 环境变量配置
系统通过 `.env` 文件或环境变量进行配置：

```bash
# 数据库配置
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/dbname

# AI 模型配置
MODEL_NAME=gpt-4
FOOD_AI_USE_MODEL=chatgpt  # 可选: chatgpt, zhipu

# OpenAI 配置
OPENAI_API_KEY=sk-xxx
OPENAI_API_BASE=https://api.openai.com/v1

# 智谱 AI 配置
ZHIPU_API_KEY=xxx

# FastAPI 配置
FAST_API_TITLE=智能食物识别系统
LOG_LEVEL=INFO  # 可选: INFO, WARNING, ERROR

# ChromaDB 配置
CHROMA_HOST=localhost
CHROMA_PORT=8000

# 文本向量模型配置
TEXT2VEC_MODEL_PATH=./models/text2vec-base-chinese

# 环境设置
ENVIRONMENT=development  # 可选: development, production
```

### 7.2 生产环境配置
- 生产环境自动将日志级别设置为 `WARNING`
- 支持 Docker 部署
- 支持环境变量覆盖配置

---

## 8. 错误处理

### 8.1 错误类型
- **AppError**: 应用层自定义错误
- **HTTPException**: FastAPI HTTP 异常
- **数据库错误**: SQLAlchemy 异常
- **AI 模型错误**: LLM 调用异常

### 8.2 错误响应格式
```json
{
    "detail": "错误描述信息"
}
```

### 8.3 常见错误码
- `400`: 请求参数错误
- `500`: 服务器内部错误

---

## 9. 日志系统

### 9.1 日志配置
- 使用 `loguru` 库进行日志记录
- 支持不同日志级别（INFO, WARNING, ERROR）
- 自动记录请求信息（方法、路径、状态码、处理时间）

### 9.2 日志内容
- 应用启动/关闭
- API 请求详情（方法、路径、参数、响应时间）
- AI 模型调用信息
- 数据库操作信息
- 错误堆栈跟踪

---

## 10. 部署说明

### 10.1 本地开发环境
```bash
# 1. 创建虚拟环境
python3.12 -m venv myenv
source myenv/bin/activate

# 2. 安装依赖
pip install -r requirements.txt

# 3. 下载模型
sh download_model.sh

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 5. 启动服务
uvicorn app.server:app --host 0.0.0.0 --port 5513 --reload
```

### 10.2 Docker 部署
```bash
# 开发环境
ENV=development docker-compose up -d

# 生产环境
ENV=production docker-compose up -d

# 重新构建镜像
docker-compose build

# 查看日志
docker-compose logs -f web

# 停止服务
docker-compose down
```

### 10.3 依赖要求
- Python 3.12（推荐，避免 numpy 版本冲突）
- PostgreSQL 数据库
- ChromaDB 服务
- 足够的磁盘空间存储模型文件

---

## 11. 性能优化

### 11.1 批量处理
- 食材同步：每批 1000 条
- 餐食同步：每批 1000 条

### 11.2 异步处理
- 使用 FastAPI 的异步特性
- 后台任务异步执行
- 数据库操作异步化

### 11.3 缓存机制
- 使用 `@lru_cache()` 缓存配置对象
- 单例模式管理 AI 服务

---

## 12. 安全考虑

### 12.1 API 安全
- CORS 配置（当前允许所有来源，生产环境应限制）
- 输入验证（使用 Pydantic 模型）
- SQL 注入防护（使用 SQLAlchemy ORM）

### 12.2 数据安全
- 敏感信息（API Key）通过环境变量配置
- 数据库连接使用连接池
- 日志不记录敏感信息

---

## 13. 未来扩展

### 13.1 功能扩展
- 支持更多 AI 模型（如 Claude、文心一言等）
- 支持视频识别
- 支持多语言
- 用户个性化推荐

### 13.2 性能优化
- 模型量化加速
- 分布式部署
- 缓存优化

### 13.3 监控和运维
- 集成 Prometheus 监控
- 健康检查接口
- 性能指标收集

---

## 14. 附录

### 14.1 数据流图
```
用户输入（文本/图片）
    ↓
API 接口层
    ↓
服务层（food_service）
    ↓
业务链层（chains）
    ├─→ 食物提取/识别
    └─→ 营养成分分析
         ↓
    RAG 检索（向量数据库）
         ↓
    LLM 分析
         ↓
数据持久化（PostgreSQL）
    ↓
返回结果
```

### 14.2 关键文件说明
- `app/server.py`: 应用入口
- `app/core/setup.py`: 应用初始化
- `app/api/endpoints/`: API 端点定义
- `app/services/`: 业务服务层
- `app/chains/`: LangChain 业务链
- `app/models/`: 数据模型定义
- `app/core/vector_store.py`: 向量数据库封装
- `app/tasks/`: 后台任务

---

**文档版本**: v1.0  
**最后更新**: 2024-10-01  
**维护者**: 开发团队


